# sensors.yaml
sensor:
  # Temperatursensoren
  - platform: homeassistant
    entity_id: sensor.environment_sensor_temperature_sensor
    id: wz_temperature
    name: "Wohnzimmer Temperatur"
    trigger_on_initial_state: true
    on_value:
      then:
        - lvgl.label.update:
            id: temperatures
            text: !lambda |-
              char buf[20];
              float outdoor_temp = id(outdoor_temperature).state;
              float indoor_temp = x;
              if (isnan(outdoor_temp)) outdoor_temp = 0;
              if (isnan(indoor_temp)) indoor_temp = 0;
              snprintf(buf, sizeof(buf), "%d° / %d°", (int)round(indoor_temp), (int)round(outdoor_temp));
              return std::string(buf);
        - lvgl.label.update:
            id: outdoor_temp_large_label
            text: !lambda |-
              char buf[20];
              if (isnan(x)) {
                return std::string("--.-°C");
              }
              snprintf(buf, sizeof(buf), "%.1f°C", x);
              return std::string(buf);

  - platform: homeassistant
    entity_id: sensor.aussentemperatur
    id: outdoor_temperature
    name: "Außentemperatur"
    trigger_on_initial_state: true
    on_value:
      then:
        - lvgl.label.update:
            id: temperatures
            text: !lambda |-
              char buf[20];
              float indoor_temp = id(wz_temperature).state;
              float outdoor_temp = x;
              if (isnan(indoor_temp)) indoor_temp = 0;
              if (isnan(outdoor_temp)) outdoor_temp = 0;
              snprintf(buf, sizeof(buf), "%d° / %d°", (int)round(indoor_temp), (int)round(outdoor_temp));
              return std::string(buf);

  - platform: homeassistant
    entity_id: sensor.flur_temperatur_temperature
    id: flur_temperature_sensor
    name: "Flur Temperatur"
    trigger_on_initial_state: true
    on_value:
      then:
        - lvgl.label.update:
            id: flur_temp_value_label
            text: !lambda |-
              char buf[20];
              if (isnan(x)) {
                return std::string("--.-°C");
              }
              snprintf(buf, sizeof(buf), "%.1f°C", x);
              return std::string(buf);

  - platform: homeassistant
    entity_id: sensor.flur_temperatur_humidity
    id: flur_humidity_sensor
    name: "Flur Luftfeuchtigkeit"
    trigger_on_initial_state: true
    on_value:
      then:
        - lvgl.label.update:
            id: flur_humidity_value_label
            text: !lambda |-
              char buf[20];
              if (isnan(x)) {
                return std::string("--.-%");
              }
              snprintf(buf, sizeof(buf), "%.1f%%", x);
              return std::string(buf);

  # WLAN Signal Sensor
  - platform: wifi_signal
    name: "Wifi Signal Strength"
    id: wifi_signal_sensor
    update_interval: 15s
    entity_category: "diagnostic"
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: wifi_icon_label
            text: !lambda |-
              if (!network::is_connected()) {
                return std::string("\U000F05AA");  # WLAN aus Icon
              } else {
                return std::string("\U000F16BB");  # WLAN an Icon
              }

text_sensor:
  # Home Assistant Display Data Sensor
  - platform: homeassistant
    id: ha_display_data_sensor
    entity_id: sensor.esphome_display_data
    attribute: json_data
    trigger_on_initial_state: true
    on_value:
      then:
        - script.execute: update_ui_from_json

script:
  - id: update_ui_from_json
    mode: parallel
    then:
      # WZ Lichtschalter
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["wz_lichtschalter"].is<std::string>()) {
                  result = root["wz_lichtschalter"].as<std::string>() == "on";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: wz_lichtschalter_button, state: { checked: true } }
            - lvgl.label.update: { id: wz_lichtschalter_icon, text: $ceiling_group_on }
          else:
            - lvgl.widget.update: { id: wz_lichtschalter_button, state: { checked: false } }
            - lvgl.label.update: { id: wz_lichtschalter_icon, text: $ceiling_group_off }

      # Esszimmer Tisch
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["ez_tisch"].is<std::string>()) {
                  result = root["ez_tisch"].as<std::string>() == "on";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: esszimmertisch_button, state: { checked: true } }
            - lvgl.label.update: { id: esszimmertisch_icon, text: $ceiling_on }
          else:
            - lvgl.widget.update: { id: esszimmertisch_button, state: { checked: false } }
            - lvgl.label.update: { id: esszimmertisch_icon, text: $ceiling_off }

      # Apple TV Status
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["apple_tv_status"].is<std::string>()) {
                  result = root["apple_tv_status"].as<std::string>() != "off";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: apple_tv_button, state: { checked: true } }
            - lvgl.image.update: { id: apple_tv_icon, src: apple_tv_on }
          else:
            - lvgl.widget.update: { id: apple_tv_button, state: { checked: false } }
            - lvgl.image.update: { id: apple_tv_icon, src: apple_tv_off }

      # Rollläden Status - Opening
      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if ((root["cover_wz_links"].is<std::string>() && root["cover_wz_links"].as<std::string>() == "opening") || 
                    (root["cover_wz_rechts"].is<std::string>() && root["cover_wz_rechts"].as<std::string>() == "opening") || 
                    (root["cover_ez_links"].is<std::string>() && root["cover_ez_links"].as<std::string>() == "opening") || 
                    (root["cover_ez_rechts"].is<std::string>() && root["cover_ez_rechts"].as<std::string>() == "opening")) { 
                  r = true; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.widget.update: { id: wz_blinds_toggle_button, state: { checked: true } }
            - lvgl.label.update: { id: wz_blinds_toggle_icon, text: $blinds_open }
            - lvgl.label.update: { id: wz_blinds_toggle_label, text: "Öffnen..." }

      # Rollläden Status - Closing
      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if ((root["cover_wz_links"].is<std::string>() && root["cover_wz_links"].as<std::string>() == "closing") || 
                    (root["cover_wz_rechts"].is<std::string>() && root["cover_wz_rechts"].as<std::string>() == "closing") || 
                    (root["cover_ez_links"].is<std::string>() && root["cover_ez_links"].as<std::string>() == "closing") || 
                    (root["cover_ez_rechts"].is<std::string>() && root["cover_ez_rechts"].as<std::string>() == "closing")) { 
                  r = true; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.widget.update: { id: wz_blinds_toggle_button, state: { checked: true } }
            - lvgl.label.update: { id: wz_blinds_toggle_icon, text: $blinds_closed }
            - lvgl.label.update: { id: wz_blinds_toggle_label, text: "Schließen..." }

      # Rollläden Status - Open
      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if (root["cover_wz_links"].is<std::string>() && root["cover_wz_links"].as<std::string>() == "open") { 
                  r = true; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.widget.update: { id: wz_blinds_toggle_button, state: { checked: true } }
            - lvgl.label.update: { id: wz_blinds_toggle_icon, text: $blinds_open }
            - lvgl.label.update: { id: wz_blinds_toggle_label, text: "Geöffnet" }

      # Rollläden Status - All Closed
      - if:
          condition:
            lambda: |-
              bool r = true;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (!root["cover_wz_links"].is<std::string>() || root["cover_wz_links"].as<std::string>() != "closed") r = false;
                if (!root["cover_wz_rechts"].is<std::string>() || root["cover_wz_rechts"].as<std::string>() != "closed") r = false;
                if (!root["cover_ez_links"].is<std::string>() || root["cover_ez_links"].as<std::string>() != "closed") r = false;
                if (!root["cover_ez_rechts"].is<std::string>() || root["cover_ez_rechts"].as<std::string>() != "closed") r = false;
                return true;
              });
              return r;
          then:
            - lvgl.widget.update: { id: wz_blinds_toggle_button, state: { checked: false } }
            - lvgl.label.update: { id: wz_blinds_toggle_icon, text: $blinds_closed }
            - lvgl.label.update: { id: wz_blinds_toggle_label, text: "Geschlossen" }

      # Rollläden Status - Partially Open
      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                std::string s = root["cover_wz_links"].is<std::string>() ? root["cover_wz_links"].as<std::string>() : ""; 
                if (s != "open" && s != "closed" && s != "opening" && s != "closing" && !s.empty()) { 
                  r = true; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.widget.update: { id: wz_blinds_toggle_button, state: { checked: true } }
            - lvgl.label.update: { id: wz_blinds_toggle_icon, text: $blinds_open }
            - lvgl.label.update: { id: wz_blinds_toggle_label, text: "Teilweise" }

      # WZ Stehlampe
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["wz_stehlampe"].is<std::string>()) {
                  result = root["wz_stehlampe"].as<std::string>() == "on";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: wohnzimmer_stehlampe_button, state: { checked: true } }
            - lvgl.label.update: { id: wohnzimmer_stehlampe_icon, text: $floor_lamp_on }
          else:
            - lvgl.widget.update: { id: wohnzimmer_stehlampe_button, state: { checked: false } }
            - lvgl.label.update: { id: wohnzimmer_stehlampe_icon, text: $floor_lamp_off }

      # Esszimmer Nische
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["light_esszimmer_nische"].is<std::string>()) {
                  result = root["light_esszimmer_nische"].as<std::string>() == "on";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: nische_button, state: { checked: true } }
            - lvgl.label.update: { id: nische_icon, text: $ledstripe_on }
          else:
            - lvgl.widget.update: { id: nische_button, state: { checked: false } }
            - lvgl.label.update: { id: nische_icon, text: $ledstripe_off }

      # Sideboard
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["light_shapes_8363"].is<std::string>()) {
                  result = root["light_shapes_8363"].as<std::string>() == "on";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: sideboard_button, state: { checked: true } }
            - lvgl.label.update: { id: sideboard_icon, text: $ledstripe_on }
          else:
            - lvgl.widget.update: { id: sideboard_button, state: { checked: false } }
            - lvgl.label.update: { id: sideboard_icon, text: $ledstripe_off }

      # EZ Stehlampe
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["ez_stehlampe"].is<std::string>()) {
                  result = root["ez_stehlampe"].as<std::string>() == "on";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: esszimmer_stehlampe_button, state: { checked: true } }
            - lvgl.label.update: { id: esszimmer_stehlampe_icon, text: $floor_lamp_variant_on }
          else:
            - lvgl.widget.update: { id: esszimmer_stehlampe_button, state: { checked: false } }
            - lvgl.label.update: { id: esszimmer_stehlampe_icon, text: $floor_lamp_variant_off }

      # WZ Deckenlampe
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["wz_decke"].is<std::string>()) {
                  result = root["wz_decke"].as<std::string>() == "on";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: wohnzimmer_deckenlampe_button, state: { checked: true } }
            - lvgl.label.update: { id: wohnzimmer_deckenlampe_icon, text: $ceiling_on }
          else:
            - lvgl.widget.update: { id: wohnzimmer_deckenlampe_button, state: { checked: false } }
            - lvgl.label.update: { id: wohnzimmer_deckenlampe_icon, text: $ceiling_off }

      # EZ Kugellampe
      - if:
          condition:
            lambda: |-
              bool result = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if (root["esszimmer_kugellampe"].is<std::string>()) {
                  result = root["esszimmer_kugellampe"].as<std::string>() == "on";
                }
                return true;
              });
              return result;
          then:
            - lvgl.widget.update: { id: esszimmer_kugellampe_button, state: { checked: true } }
            - lvgl.label.update: { id: esszimmer_kugellampe_icon, text: $kugel_on }
          else:
            - lvgl.widget.update: { id: esszimmer_kugellampe_button, state: { checked: false } }
            - lvgl.label.update: { id: esszimmer_kugellampe_icon, text: $kugel_off }

      # Wetter Beschreibung
      - lvgl.label.update:
          id: weather_description
          text: !lambda |-
            std::string result = "---";
            json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
              if (root["wetter_zustand"].is<std::string>()) {
                result = root["wetter_zustand"].as<std::string>();
              }
              return true;
            });
            return result;

      # VOLLSTÄNDIGE Wetter Icons
      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_clear_night"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_clear_night }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_cloudy"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_cloudy }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_exceptional"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_exceptional }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_fog"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_fog }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_hail"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_hail }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_lightning"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_lightning }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_lightning_rainy"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_lightning_rainy }

      - if:
          condition:
            lambda: |-
              bool r = false;
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool {
                if(root["wetter_icon"].is<std::string>()) {
                  r = root["wetter_icon"].as<std::string>() == "icon_png_partlycloudy";
                }
                return true;
              });
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_partlycloudy }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_pouring"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_pouring }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_rainy"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_rainy }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_snowy"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_snowy }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_snowy_rainy"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_snowy_rainy }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_sunny"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_sunny }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_windy"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_windy }

      - if:
          condition:
            lambda: |-
              bool r = false; 
              json::parse_json(id(ha_display_data_sensor).state, [&](JsonObject root) -> bool { 
                if(root["wetter_icon"].is<std::string>()) { 
                  r = root["wetter_icon"].as<std::string>() == "icon_png_windy_variant"; 
                } 
                return true; 
              }); 
              return r;
          then:
            - lvgl.image.update: { id: lvgl_weather_image_widget, src: icon_png_windy_variant }
